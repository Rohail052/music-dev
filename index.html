<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AllPlay ðŸŽ¶ Spotify Edition</title>
<style>
  /* Basic CSS styling */
  :root {
    --bg: #121212;
    --text: #eee;
    --accent: #1db954;
    --card: #222;
    --shadow: rgba(0,0,0,0.6);
    --transition-duration: 0.4s;
  }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0; 
    min-height: 100vh;
  }
  header {
    padding: 15px;
    background: #000;
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
  }
  main {
    max-width: 900px;
    margin: 20px auto;
    padding: 0 15px;
  }
  input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  button {
    background: var(--accent);
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 1rem;
    color: #000;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #14833b;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  li {
    background: var(--card);
    margin: 10px 0;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background-color 0.3s ease;
  }
  li:hover {
    background: #1db954aa;
  }
  img {
    width: 64px;
    height: 64px;
    border-radius: 8px;
    object-fit: cover;
  }
  .song-info {
    flex-grow: 1;
  }
  .logout-btn {
    position: fixed;
    top: 15px;
    right: 15px;
    background: #f33;
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
  }
  .status {
    margin: 10px 0;
    font-style: italic;
    color: #ccc;
  }
</style>
</head>
<body>

<header>AllPlay ðŸŽ¶ Spotify Edition</header>

<main>
  <button id="logoutBtn" class="logout-btn" style="display:none;">Logout</button>
  
  <input type="text" id="searchInput" placeholder="Search for songs or artists..." />
  <button id="searchBtn">Search Spotify</button>
  
  <div id="status" class="status"></div>
  
  <ul id="resultsList"></ul>
  
  <h3>Your Playlist</h3>
  <ul id="playlist"></ul>
</main>

<script>
(() => {
  const clientId = '248cd7a9e2be4cfdb3e3c56a64369ea7';
  const redirectUri = window.location.origin + window.location.pathname;
  const scopes = [
    'user-read-private',
    'user-read-email',
    'playlist-read-private',
    'playlist-modify-public',
    'playlist-modify-private',
    'streaming',
    'user-read-playback-state',
    'user-modify-playback-state'
  ].join(' ');

  // Elements
  const logoutBtn = document.getElementById('logoutBtn');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const resultsList = document.getElementById('resultsList');
  const playlistEl = document.getElementById('playlist');
  const statusEl = document.getElementById('status');

  // Authentication & token management using Implicit Grant flow
  function login() {
    const authUrl = new URL('https://accounts.spotify.com/authorize');
    authUrl.searchParams.set('client_id', clientId);
    authUrl.searchParams.set('response_type', 'token');
    authUrl.searchParams.set('redirect_uri', redirectUri);
    authUrl.searchParams.set('scope', scopes);
    authUrl.searchParams.set('show_dialog', 'true');
    window.location = authUrl.toString();
  }

  function logout() {
    sessionStorage.removeItem('spotify_access_token');
    window.location.href = redirectUri;
  }

  function getAccessTokenFromUrl() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }

  function clearUrlHash() {
    history.replaceState(null, '', window.location.pathname);
  }

  function getToken() {
    let token = sessionStorage.getItem('spotify_access_token');
    if (!token) {
      token = getAccessTokenFromUrl();
      if (token) {
        sessionStorage.setItem('spotify_access_token', token);
        clearUrlHash();
      }
    }
    return token;
  }

  // Spotify API helper
  async function spotifyFetch(endpoint, options = {}) {
    const token = getToken();
    if (!token) {
      login();
      return;
    }
    options.headers = {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json',
      ...options.headers
    };
    const res = await fetch('https://api.spotify.com/v1' + endpoint, options);
    if (res.status === 401) {
      // Token expired or invalid, logout and re-login
      logout();
      return;
    }
    return await res.json();
  }

  // Search tracks
  async function searchTracks(query) {
    statusEl.textContent = 'Searching...';
    const data = await spotifyFetch('/search?type=track&q=' + encodeURIComponent(query) + '&limit=10');
    statusEl.textContent = '';
    if (!data || !data.tracks) {
      statusEl.textContent = 'No results or error.';
      return [];
    }
    return data.tracks.items;
  }

  // Render search results
  function renderSearchResults(tracks) {
    resultsList.innerHTML = '';
    tracks.forEach(track => {
      const li = document.createElement('li');
      li.innerHTML = `
        <img src="${track.album.images[2]?.url || ''}" alt="album art" />
        <div class="song-info">
          <strong>${track.name}</strong><br/>
          ${track.artists.map(a => a.name).join(', ')}
        </div>
      `;
      li.onclick = () => addToPlaylist(track);
      resultsList.appendChild(li);
    });
  }

  // Playlist management (simple in-memory)
  const playlist = [];

  function addToPlaylist(track) {
    if (playlist.some(t => t.id === track.id)) {
      alert('Track already in playlist!');
      return;
    }
    playlist.push(track);
    renderPlaylist();
  }

  function renderPlaylist() {
    playlistEl.innerHTML = '';
    playlist.forEach((track, i) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <img src="${track.album.images[2]?.url || ''}" alt="album art" />
        <div class="song-info">
          <strong>${track.name}</strong><br/>
          ${track.artists.map(a => a.name).join(', ')}
        </div>
        <button data-index="${i}">Remove</button>
      `;
      li.querySelector('button').onclick = e => {
        e.stopPropagation();
        playlist.splice(i, 1);
        renderPlaylist();
      };
      playlistEl.appendChild(li);
    });
  }

  // Initialization
  function init() {
    const token = getToken();
    if (!token) {
      login();
      return;
    }
    logoutBtn.style.display = 'inline-block';
    logoutBtn.onclick = logout;

    searchBtn.onclick = async () => {
      const query = searchInput.value.trim();
      if (!query) {
        alert('Please enter a search term.');
        return;
      }
      const tracks = await searchTracks(query);
      renderSearchResults(tracks);
    };
  }

  window.onload = init;
})();
</script>

</body>
</html>
